# å¼€å‘ç¬”è®°



# ç™»å½•æ³¨å†Œå®ç°

éœ€æ±‚, ç”¨æˆ·ç™»å½•æ³¨å†Œå¹¶ä¸”æœ‰æ—¥å¿—è®°å½•

## æŠ€æœ¯é€‰å‹

å¸¸ç”¨çš„ç™»å½• session. åˆ†å¸ƒå¼session(redis).  JWT.

å•ä½“é¡¹ç›®æ²¡å¿…è¦redis.

session å’Œ JWT. sessionå§.



## å…·ä½“å®ç°

åº“è¡¨è®¾è®¡

```sql
create  database  supstar;

use supstar;
-- ç”¨æˆ·è¡¨
create table if not exists user
(
    id           bigint auto_increment comment 'id' primary key,
    userAccount  varchar(256)                           not null comment 'è´¦å·',
    userPassword varchar(512)                           not null comment 'å¯†ç ',
    userName     varchar(256)                           null comment 'ç”¨æˆ·æ˜µç§°',
    userAvatar   varchar(1024)                          null comment 'ç”¨æˆ·å¤´åƒ',
    userRole     varchar(256) default 'user'            not null comment 'ç”¨æˆ·è§’è‰²ï¼šuser/admin',
    createTime   datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete     tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    index idx_userAccount (userAccount)
) comment 'ç”¨æˆ·' collate = utf8mb4_unicode_ci;

```

å¼•å…¥ä¾èµ–

web, aop , mysql, mybatis,mybatis-plus, knife4j,lombok,springtest,hutool,common

```xml
 <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>


        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.2.2</version>
        </dependency>



        <!-- https://mvnrepository.com/artifact/com.baomidou/mybatis-plus-boot-starter -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.2</version>
        </dependency>



        <!-- https://doc.xiaominfo.com/docs/quick-start#openapi2 -->
        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
            <version>4.4.0</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>


        <!-- https://hutool.cn/docs/index.html#/-->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.8.8</version>
        </dependency>


        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
```

1ï¼‰ æ³¨å†Œ

å‚æ•° username. password,checkpassword.

```java
    /**
     * ç”¨æˆ·æ³¨å†Œ
     * @param userAccount
     * @param userPassword
     * @param checkPassword
     * @return
     */
    @Override
    public long register(String userAccount, String userPassword, String checkPassword) {
        // é€»è¾‘æ ¡éªŒ
        if (StringUtils.isAnyBlank(userAccount, userPassword, checkPassword)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
        }

        // ä¸šåŠ¡æ ¡éªŒ
        if (userAccount.length() < 4) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·è´¦å·è¿‡çŸ­");
        }
        if (userPassword.length() < 8 || checkPassword.length() < 8) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·å¯†ç è¿‡çŸ­");
        }
        // å¯†ç å’Œæ ¡éªŒå¯†ç ç›¸åŒ
        if (!userPassword.equals(checkPassword)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
        }

        synchronized (userAccount.intern()) {
            // è´¦æˆ·ä¸èƒ½é‡å¤
            LambdaQueryWrapper<User> userLambdaQueryWrapper = new LambdaQueryWrapper<>();
            userLambdaQueryWrapper.eq(User::getUserAccount, userAccount);
            long count = this.baseMapper.selectCount(userLambdaQueryWrapper);
            if (count > 0) {
                throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é‡å¤");
            }
            // 2. åŠ å¯†
            String encryptPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
            // 3. æ’å…¥æ•°æ®
            User user = new User();
            user.setUserAccount(userAccount);
            user.setUserPassword(encryptPassword);
            user.setUserName(userAccount);


            boolean saveResult = this.save(user);
            if (!saveResult) {
                throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ³¨å†Œå¤±è´¥ï¼Œæ•°æ®åº“é”™è¯¯");
            }
            return user.getId();
        }
    }
```

2ï¼‰ç™»å½•

15min

```java
   /**
     * ç”¨æˆ·ç™»å½•
     * @param userAccount
     * @param userPassword
     * @return
     */
    @Override
    public LoginUserVo login(String userAccount, String userPassword, HttpServletRequest request) {
        //å‚æ•°é€»è¾‘æ ¡éªŒ
        if (StringUtils.isAnyBlank(userAccount, userPassword)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
        }

        // ä¸šåŠ¡é€»è¾‘æ ¡éªŒ  èƒ½é¿å…ä¸ç¬¦åˆçš„æ•°æ®ç›´æ¥è¯·æ±‚æ•°æ®åº“
        if (userAccount.length() < 4) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é”™è¯¯");
        }
        if (userPassword.length() < 8) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "å¯†ç é”™è¯¯");
        }

        // è´¦æˆ·æ˜¯å¦å­˜åœ¨
        LambdaQueryWrapper<User> userLambdaQueryWrapper = new LambdaQueryWrapper<>();
        userLambdaQueryWrapper.eq(User::getUserAccount, userAccount);
        User user = this.getOne(userLambdaQueryWrapper);
        if (user == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        // å¯†ç æ˜¯å¦æ­£ç¡®
        String encryptPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
        if (!Objects.equals(user.getUserPassword(), encryptPassword)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "å¯†ç é”™è¯¯");
        }

        // è¿”å›ç»“æœ ä¸è¿”å›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚è¯´å¯†ç 
        LoginUserVo loginUserVo = new LoginUserVo();
        BeanUtils.copyProperties(user, loginUserVo);


        //å­˜åœ¨å°†ç”¨æˆ·ä¿¡æ¯å­˜åœ¨sessionä¸­
        request.getSession().setAttribute("user",loginUserVo);
        return loginUserVo;
    }
```

ok, ç™»å½•

å¯¹èº«ä»½è¿›è¡ŒéªŒè¯ã€‚ sessionã€‚

ç¼–å†™æ‹¦æˆªå™¨

```java
/**
 * æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªéœ€è¦è®¤è¯çš„ä¸šåŠ¡
 */
public class LoginInterceptor implements HandlerInterceptor {


    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        //  sessionç™»å½•æ–¹å¼
//        //1. è·å–session
        HttpSession session = request.getSession();
//        // 2. è·å–sessionä¸­çš„ç”¨æˆ·
        Object user = session.getAttribute("user");
        if (user == null ) {
            //æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯
            response.setStatus(401);
            response.setContentType("application/json");
            response.setCharacterEncoding("UTF-8");
            response.getWriter().write("{\"code\": 401, \"message\": \"ç”¨æˆ·æœªç™»å½•\"}");
            return false;
        }

//        //3. todo ä¿å­˜åˆ°ThreadLocalä¸­
//        UserHolder.saveUser((User) user);

        return true;

    }

    // todo ThreadLocal
//    @Override
//    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
//       //ç§»é™¤ä¿¡æ¯ï¼Œé¿å…å†…å­˜æ³„éœ²
//        UserHolder.removeUser();
//    }
}
```

é…ç½®æ‹¦æˆªå™¨

```java
/**
 * webMvc é…ç½®
 */
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    /**
     * æ·»åŠ æ‹¦æˆªå™¨
     * @param registry
     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {

        registry.addInterceptor(new LoginInterceptor())
                .excludePathPatterns(
                        "/doc.html",
                        "/webjars/**",
                        "/swagger-resources",
                        "/swagger-resources/**",
                        "/v3/**",
                        "/favicon.ico",
                        "Mozilla/**",
            
                        "/user/register",
                        "/user/login");

    }
}
```



å…¶ä¸­ æ˜¯æ’é™¤knif4j 

```java
 .excludePathPatterns(
                        "/doc.html",
                        "/webjars/**",
                        "/swagger-resources",
                        "/swagger-resources/**",
                        "/v3/**",
                        "/favicon.ico",
                        "Mozilla/**",)
     
```



# æ—¥å¿—çš„å®ç°

## æŠ€æœ¯é€‰å‹

Spring Boot å†…ç½® **Logback** ä½œä¸ºé»˜è®¤æ—¥å¿—æ¡†æ¶ï¼Œå¹¶ä¸”æ”¯æŒ **SLF4J** ã€‚

ELK ä¹‹åè€ƒè™‘ã€‚

## å®ç°

åœ¨æ¯ä¸ªè¯·æ±‚æ¥ä¸´éƒ½è¿›è¡Œæ‹¦æˆªï¼Œè®°å½•æ—¥å¿—ï¼Œæ¯”å¦‚ ip,è¯·æ±‚åœ°å€ï¼Œè¯·æ±‚å‚æ•°ï¼Œä»¥åŠå“åº”ä¿¡æ¯ã€‚

å¯ä»¥ä½¿ç”¨æ‹¦æˆªå™¨ï¼Œæˆ–è€…AOPã€‚

[è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨å’ŒAOPçš„åˆ†æä¸å¯¹æ¯” - ğŸ«æ²™æ¼ éª†é©¼ - åšå®¢å›­](https://www.cnblogs.com/goSilver/p/11773972.html)

æ€»çš„æ¥è¯´ï¼Œè¿‡æ»¤å™¨ï¼Œæ˜¯æ‰€æœ‰çš„è¯·æ±‚ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾æœåŠ¡ä¹‹å‰ï¼Œé€šè¿‡è¿‡æ»¤çš„è¯·æ±‚æ‰èƒ½è®¿é—®æˆ‘ä»¬çš„controller(æ¯”å¦‚è¯´ï¼Œåœ¨è¿‡æ»¤å™¨è¿‡æ»¤é»‘åå•)ã€‚

springWebæä¾›çš„æ‹¦æˆªå™¨ï¼Œæ˜¯æ‹¦æˆªæ‰€æœ‰çš„åˆ°è¾¾controllerå±‚çš„ä»£ç ï¼Œåœ¨æ‰§è¡Œcontrollerå±‚ä»£ç å‰åï¼Œè¿›è¡Œå¢å¼º(æ¯”å¦‚è¯´æƒé™æ ¡éªŒã€‚)

AOP çš„æ˜¯åŠ¨æ€ä»£ç†ï¼Œä¹Ÿå°±æ˜¯å®ç°äº†æ¥å£çš„æ–¹æ³•ï¼Œè¿›è¡Œå¢å¼ºã€‚å¯ä»¥å®ç°serviceå±‚çš„æ‹¦æˆªã€‚

Springwebæ‹¦æˆªå™¨å’ŒAOP çš„é€‰æ‹©ï¼Ÿ

Springwebæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªcontrollerå±‚ä»£ç ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨url,requestç­‰æ›´æ–¹ä¾¿ä½¿ç”¨controller APIï¼Œã€€æƒé™æ ¡éªŒï¼ˆç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼‰å»ºè®®åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œã€‚

AOP æ¯”æ‹¦æˆªå™¨æ›´çµæ´»ï¼Œæ—¥å¿—å®Œå…¨å¯ä»¥ä½¿ç”¨AOPï¼Œæ¯”æ‹¦æˆªå™¨å¥½ï¼Œæˆ–è€…ä½¿ç”¨æ‹¦æˆªå™¨è®°å½•controllerï¼Œaopè®°å½•service.



æœ¬æ¬¡ä½¿ç”¨AOPæ¥è¿›è¡Œæƒé™å®ç°ã€‚

```java
**
 * æ—¥å¿— AOP
 */
@Component
@Aspect
@Slf4j
public class LogInterceptor {


    @Around("execution(* com.ls.supstar.controller.*.*(..))")
    public Object doInterceptor(ProceedingJoinPoint point) throws Throwable {

        // è®°æ—¶
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        // è·å–è¯·æ±‚çš„è·¯å¾„
        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();

        // ç”Ÿæˆè¯·æ±‚æ—¥å¿—å”¯ä¸€id
        String requestId = UUID.randomUUID().toString();

        // è¯·æ±‚çš„ip
        String requestIp = request.getRemoteAddr();


        // å‘èµ·è¯·æ±‚çš„ç”¨æˆ·
        Object user = request.getSession().getAttribute("user");

        // è¯·æ±‚url
        String url = request.getRequestURL().toString();



        // è¯·æ±‚å‚æ•°
        Object[] args = point.getArgs();

        String reqParam = "[" + StringUtils.join(args, ",") + "]";

        // è¾“å‡ºè¯·æ±‚æ—¥å¿—
        log.info("request start: requestId:{}, userId:{},requestIp:{},url:{}, reqParam:{}", requestId,user,requestIp, url, reqParam);

//        // æ‰§è¡ŒåŸæ–¹æ³•
//        Object result = point.proceed();
//
//        String respParam = result != null ? result.toString() : "null";
//        // è·å–ç›¸åº”æ˜¯å¦æˆåŠŸ
//        // è·å–å“åº”ç»“æœ
//        // è¾“å‡ºå“åº”æ—¥å¿—
//        stopWatch.stop();
//        long totalTimeMillis = stopWatch.getTotalTimeMillis();
//        log.info("request end:, requestId: {}, cost: {}ms", requestId, totalTimeMillis);



            // æ‰§è¡Œç›®æ ‡æ–¹æ³•å¹¶è·å–å“åº”ç»“æœ
            Object result = point.proceed();

            // å°†å“åº”ç»“æœè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            String respParam = result != null ? result.toString() : "null";

            // è¾“å‡ºå“åº”æ—¥å¿—
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.info("request end: requestId: {}, cost: {}ms, respParam: {}", requestId, totalTimeMillis, respParam);


        return result;

    }


}
```

é»˜è®¤æ˜¯åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨

```yaml
# æ—¥å¿—
logging:
  file:
    name: app.logs
    path: logs

```

ä¸Šè¿°å¯¹äºæ­£å¸¸çš„è¯·æ±‚ï¼ˆæ­£å¸¸æ‰§è¡Œå®Œæ¯•å¯ä»¥è®°å½•ä¸‹æ¥ï¼Œå¯¹äºå¼‚å¸¸å°±ä¸è¡Œäº†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨é‚£é‡Œè®°å½•æ—¥å¿—ï¼‰ã€‚

æˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼Œæ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯éƒ½åœ¨aopä¸­è®°å½•ï¼ŒåŒ…æ‹¬å¼‚å¸¸ï¼Œç„¶åæŠ›å‡ºï¼Œåœ¨å…¨å±€å¼‚å¸¸å†æ¬¡è¾“å‡ºè¯¦ç»†çš„æŠ¥é”™ä¿¡æ¯

ä¿®æ”¹å¦‚ä¸‹

aop æ—¥å¿—

```java
package com.ls.supstar.aop;


import com.ls.supstar.exeception.BusinessException;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;
import org.springframework.util.StopWatch;
import org.springframework.web.context.request.RequestAttributes;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.Random;
import java.util.UUID;

/**
 * æ—¥å¿— AOP
 */
@Component
@Aspect
@Slf4j
public class LogInterceptor {


    @Around("execution(* com.ls.supstar.controller.*.*(..))")
    public Object doInterceptor(ProceedingJoinPoint point) throws Throwable {

        // è®°æ—¶
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        // è·å–è¯·æ±‚çš„è·¯å¾„
        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();

        // ç”Ÿæˆè¯·æ±‚æ—¥å¿—å”¯ä¸€id
        String requestId = UUID.randomUUID().toString();

        // è¯·æ±‚çš„ip
        String requestIp = request.getRemoteAddr();

//        // è¯·æ±‚çš„ä¸»æœºåç§°
//        String clientHostName = getClientHostName(requestIp);


        // å‘èµ·è¯·æ±‚çš„ç”¨æˆ·
        Object user = request.getSession().getAttribute("user");

        // è¯·æ±‚url
        String url = request.getRequestURL().toString();



        // todo è¯·æ±‚å‚æ•°, æ³¨æ„éšç§ï¼Œç‰¹åˆ«æ˜¯å¯†ç è¦è¿›è¡ŒåŠ å¯†
//        Object[] args = point.getArgs();
//
//        String reqParam = "[" + StringUtils.join(args, ",") + "]";

        // è¾“å‡ºè¯·æ±‚æ—¥å¿—
//        log.info("request start: requestId:{}, userId:{},requestIp:{},url:{}, reqParam:{}", requestId,user,requestIp, url, reqParam);
        log.info("request start: requestId:{}, userId:{},requestIp:{},url:{}", requestId,user,requestIp, url);




        Object result = null;
        try {

            // æ‰§è¡Œç›®æ ‡æ–¹æ³•å¹¶è·å–å“åº”ç»“æœ
            result = point.proceed();

            // å°†å“åº”ç»“æœè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            String respParam = result != null ? result.toString() : "error";

            // è¾“å‡ºå“åº”æ—¥å¿—
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.info("request end: requestId: {}, cost: {}ms, respParam: {}", requestId, totalTimeMillis, respParam);
        } catch (BusinessException e) {
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.error("Business exception caught: requestId: {}, cost: {}ms, code: {}, message: {}",
                    requestId, totalTimeMillis, e.getCode(), e.getMessage());
            throw e; // ä¿æŒ BusinessException ç±»å‹ä¸å˜
        } catch (Exception e) {
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.error("System exception caught: requestId: {}, cost: {}ms, message: {}",
                    requestId, totalTimeMillis, e.getMessage());
            throw e; // ä¿æŒ Exception ç±»å‹ä¸å˜
        }
        return result;

    }


    /**
     * è·å–å®¢æˆ·ç«¯ä¸»æœºå fv
     * @param clientIp
     * @return
     */
    public static String getClientHostName(String clientIp) {
        try {
            InetAddress inetAddress = InetAddress.getByName(clientIp);
            return inetAddress.getHostName();
        } catch (UnknownHostException e) {
            return "unknown";
        }
    }

}

```

tips: æ³¨æ„æ•è·çš„å¼‚å¸¸ã€‚ä¸è¦ç»Ÿç»Ÿæ•è·ï¼¥ï½˜ï½…ï½ƒï½ï½”ï½‰ï½ï½å¼‚å¸¸ï¼Œä¿æŒæ•è·å’ŒæŠ›å‡ºçš„å¼‚å¸¸ä¸€è‡´ï¼Œè¿™æ ·æ‰èƒ½å‘—å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†ç‰¹å®šçš„å¼‚å¸¸ã€‚

å¯¹äºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œè¡¥å……ç‰¹å®šçš„å¼‚å¸¸ï¼Œç„¶åè¾“å‡ºå¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public BaseResponse<?> businessExceptionHandler(BusinessException e) {
        log.error("BusinessException", e);
        return ResultUtils.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(RuntimeException.class)
    public BaseResponse<?> runtimeExceptionHandler(RuntimeException e) {
        log.error("RuntimeException", e);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
}
```

ä¿®æ”¹bugï¼š å¯¹äºä¸šåŠ¡é”™è¯¯ï¼Œå°±æ¯”å¦‚è¯´ç™»å½•å¯†ç é”™äº†ï¼Œè´¦å·é”™è¯¯äº†ï¼Œç­‰ç­‰è¿™äº›ï¼Œä¸šåŠ¡é€»è¾‘ä¸æ­£ç¡®ï¼Œä¸åº”è¯¥å­˜åˆ°æ—¥å¿—ä¸­ï¼Œä»…ä»…å­˜ä¸€ä¸‹ä»–é”™è¯¯å°±è¡Œäº†ï¼Œä¸åº”è¯¥å­˜é”™è¯¯çš„å®Œæ•´ä¿¡æ¯ã€‚

é”™è¯¯çš„æ¼”ç¤º

![image-20250312154959258](images/å¼€å‘ç¬”è®°.assets/image-20250312154959258.png)

è¿™ç§ä¸šåŠ¡é€»è¾‘ä¸Šçš„é”™è¯¯ï¼Œåªæ˜¯ä¸ºäº†ç»™å‰ç«¯ï¼Œè®©å‰ç«¯æç¤ºç”¨æˆ·ï¼Œä¸åº”è¯¥åœ¨æ—¥å¿—ä¸­è®°å½•ä¸‹æ¥å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ï¼Œå› ä¸ºæ²¡ç”¨ï¼Œè€Œä¸”ä¸è¦ä½¿ç”¨error

çº§åˆ«ã€‚

![image-20250312155432897](images/å¼€å‘ç¬”è®°.assets/image-20250312155432897.png)

å¦‚ä¸‹ï¼š æ­£å¸¸çš„é€»è¾‘

å¯†ç ä¸ä¸€è‡´çš„é”™è¯¯ï¼Œåªæ˜¯ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œä¸åº”è¯¥å°†å¼‚å¸¸çš„ä¿¡æ¯å…¨éƒ¨è®¡å…¥åˆ°æ—¥å¿—ä¸­ï¼Œå› ä¸ºæ²¡æœ‰ä»·å€¼ï¼Œè¿˜å ç”¨ç©ºé—´ï¼Œä»…ä»…åœ¨æ—¥å¿—ä¸­è®°å½•ä¸€ä¸‹ä»–ç™»å…¥å¤±è´¥å°±è¡Œã€‚è€Œä¸”è¿˜è¦æ³¨æ„æ—¥å¿—çº§åˆ«ï¼Œè¿™ä¸ªçº§åˆ«ä¹Ÿå°±æ˜¯info,ä¸èƒ½ä½¿ç”¨error

![image-20250312154959258](images/å¼€å‘ç¬”è®°.assets/image-20250312154959258.png)

![image-20250312155238471](images/å¼€å‘ç¬”è®°.assets/image-20250312155238471.png)

æˆ‘ä»¬çš„é€»è¾‘ï¼Œæ—¥å¿—AOPåˆ‡é¢è¾“å…¥æ—¥å¿—ï¼Œå‘ç”Ÿå¼‚å¸¸åæ•è·ï¼Œå¹¶ä¸”è¾“å…¥æ—¥å¿—ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸ï¼Œè®©æˆ‘ä»¬çš„å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†ï¼Œå¯¹äºç³»ç»Ÿå¼‚å¸¸è¦æ‰“å°errorçº§åˆ«çš„æ—¥å¿—ï¼Œå¯¹äºä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼Œä¸ç”¨æ‰“å°ï¼Œåªæ˜¯ç»™å‰ç«¯å“åº”çš„ç»“æœã€‚

æ‰€ä»¥åšå‡ºå¦‚ä¸‹ä¿®æ”¹

![image-20250312160027589](images/å¼€å‘ç¬”è®°.assets/image-20250312160027589.png)

## æ€»ç»“

æ—¥å¿—çš„å®ç°ï¼Œå…¶å®ä½¿ç”¨Springæ‹¦æˆªå™¨ï¼Œæˆ–è€…AOPæ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚åªä¸è¿‡AOPèƒ½çµæ´»ï¼Œæ¯”å¦‚è¯´æ•è·Serviceå±‚çš„ä¿¡æ¯ã€‚

æ—¥å¿—å…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œå†™ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œå®ç°ä¸€ä¸ªaroudæ–¹æ³•ï¼ˆå®šä¹‰åˆ‡ç‚¹ï¼‰è®°å½•è¯·æ±‚å‰ï¼Œæ‰§è¡Œåçš„å“åº”ï¼Œå…¶å®æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯è¦è€ƒè™‘å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µï¼Œå‘ç”Ÿå¼‚å¸¸æ—¥å¿—æ€ä¹ˆè®°å½•ï¼Œæ˜¯ç›´æ¥åœ¨å¼‚å¸¸é‚£é‡Œå†™æ—¥å¿—ï¼Œè¿˜æ˜¯åœ¨AOPä¸­å†™æ—¥å¿—ã€‚ç›´æ¥åœ¨å¼‚å¸¸é‚£é‡Œå†™æ—¥å¿—ï¼Œå°±ä¼šå¯¼è‡´æ—¥å¿—è®°å½•ä¿¡æ¯ä¸å…¨ï¼ˆåªèƒ½è®°å½•è¯·æ±‚å‰ï¼Œè¯·æ±‚åè®°å½•ä¸äº†ï¼Œå› ä¸ºåœ¨æ­¤æœŸé—´å‘ç”Ÿå¼‚å¸¸ï¼Œç¨‹åºä¼šä¸­æ–­ï¼Œå°±è®°å½•ä¸ä¸‹æ¥ï¼Œä½†æ˜¯å¯ä»¥åœ¨å‘ç”Ÿå¼‚å¸¸é‚£é‡Œå†™æ—¥å¿—ï¼ˆä½†ä»…ä»…æ˜¯æ‰“å°å‡ºå¼‚å¸¸çš„ä¿¡æ¯ï¼Œå‘è¯·æ±‚url,åœ°å€å•¥çš„è®°å½•ä¸ä¸‹æ¥ï¼Œè™½ç„¶åœ¨è¯·æ±‚å‰è®°å½•ä¸‹æ¥äº†ï¼Œæ—¥å¿—ä¸æˆå¯¹ä¸å¥½è§‚æµ‹ï¼‰ï¼‰ã€‚

æœ€ä½³å®è·µå°±æ˜¯ï¼Œåœ¨åˆ‡é¢ä¸­ä¹Ÿæ•è·å¼‚å¸¸å–è®°å½•å¼‚å¸¸çš„ä¿¡æ¯ï¼ˆcodo ,msgï¼‰ï¼Œç„¶åæŠ›å‡ºæ¥ï¼Œåœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨è®°å½•æ›´è¯¦ç»†çš„ä¿¡æ¯.



# Druid ç›‘æ§

å¼•å…¥ä¾èµ–

```xml
       <!--        https://github.com/alibaba/druid/wiki-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
            <version>1.2.22</version>
        </dependency>
```



tips: spring boot 2.7 é»˜è®¤ä½¿ç”¨Hc

éœ€è¦æ’é™¤

```xml
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.2.2</version>
            <exclusions>
                <exclusion>
                    <groupId>com.zaxxer</groupId>
                    <artifactId>HikariCP</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
```



é…ç½®

```yaml
   type: com.alibaba.druid.pool.DruidDataSource
   # Druid é…ç½®
    druid:
      # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
      initial-size: 20
      minIdle: 20
      max-active: 20
      # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
      max-wait: 60000
      # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’
      time-between-eviction-runs-millis: 2000
      # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
      min-evictable-idle-time-millis: 600000
      max-evictable-idle-time-millis: 900000
      # ç”¨æ¥æµ‹è¯•è¿æ¥æ˜¯å¦å¯ç”¨çš„SQLè¯­å¥,é»˜è®¤å€¼æ¯ç§æ•°æ®åº“éƒ½ä¸ç›¸åŒ,è¿™æ˜¯mysql
      validationQuery: select 1
      # åº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥ï¼Œå¹¶ä¸”testOnBorrowä¸ºfalseæ—¶ï¼Œè¿æ¥æ± å°†ä¼šåˆ¤æ–­è¿æ¥æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éªŒè¯è¿™æ¡è¿æ¥æ˜¯å¦å¯ç”¨
      testWhileIdle: true
      # å¦‚æœä¸ºtrueï¼Œé»˜è®¤æ˜¯falseï¼Œåº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥æ—¶ï¼Œè¿æ¥æ± ä¼šåˆ¤æ–­è¿™æ¡è¿æ¥æ˜¯å¦æ˜¯å¯ç”¨çš„
      testOnBorrow: false
      # å¦‚æœä¸ºtrueï¼ˆé»˜è®¤falseï¼‰ï¼Œå½“åº”ç”¨ä½¿ç”¨å®Œè¿æ¥ï¼Œè¿æ¥æ± å›æ”¶è¿æ¥çš„æ—¶å€™ä¼šåˆ¤æ–­è¯¥è¿æ¥æ˜¯å¦è¿˜å¯ç”¨
      testOnReturn: false
      # æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheã€‚PSCacheå¯¹æ”¯æŒæ¸¸æ ‡çš„æ•°æ®åº“æ€§èƒ½æå‡å·¨å¤§ï¼Œæ¯”å¦‚è¯´oracle
      poolPreparedStatements: true
      # è¦å¯ç”¨PSCacheï¼Œå¿…é¡»é…ç½®å¤§äº0ï¼Œå½“å¤§äº0æ—¶ï¼Œ poolPreparedStatementsè‡ªåŠ¨è§¦å‘ä¿®æ”¹ä¸ºtrueï¼Œ
      # åœ¨Druidä¸­ï¼Œä¸ä¼šå­˜åœ¨Oracleä¸‹PSCacheå ç”¨å†…å­˜è¿‡å¤šçš„é—®é¢˜ï¼Œ
      # å¯ä»¥æŠŠè¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚è¯´100
      maxOpenPreparedStatements: 20
      # è¿æ¥æ± ä¸­çš„minIdleæ•°é‡ä»¥å†…çš„è¿æ¥ï¼Œç©ºé—²æ—¶é—´è¶…è¿‡minEvictableIdleTimeMillisï¼Œåˆ™ä¼šæ‰§è¡ŒkeepAliveæ“ä½œ
      keepAlive: true
      # Spring ç›‘æ§ï¼Œåˆ©ç”¨aop å¯¹æŒ‡å®šæ¥å£çš„æ‰§è¡Œæ—¶é—´ï¼Œjdbcæ•°è¿›è¡Œè®°å½•
      aop-patterns: "com.springboot.template.dao.*"
      ########### å¯ç”¨å†…ç½®è¿‡æ»¤å™¨ï¼ˆç¬¬ä¸€ä¸ª stat å¿…é¡»ï¼Œå¦åˆ™ç›‘æ§ä¸åˆ°SQLï¼‰##########
      filters: stat,wall,log4j2
      # è‡ªå·±é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filter
      filter:
        # å¼€å¯druiddatasourceçš„çŠ¶æ€ç›‘æ§
        stat:
          enabled: true
          db-type: mysql
          # å¼€å¯æ…¢sqlç›‘æ§ï¼Œè¶…è¿‡2s å°±è®¤ä¸ºæ˜¯æ…¢sqlï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­
          log-slow-sql: true
          slow-sql-millis: 2000
        # æ—¥å¿—ç›‘æ§ï¼Œä½¿ç”¨slf4j è¿›è¡Œæ—¥å¿—è¾“å‡º
        slf4j:
          enabled: true
          statement-log-error-enabled: true
          statement-create-after-log-enabled: false
          statement-close-after-log-enabled: false
          result-set-open-after-log-enabled: false
          result-set-close-after-log-enabled: false
      ########## é…ç½®WebStatFilterï¼Œç”¨äºé‡‡é›†webå…³è”ç›‘æ§çš„æ•°æ® ##########
      web-stat-filter:
        enabled: true                   # å¯åŠ¨ StatFilter
        url-pattern: /* # è¿‡æ»¤æ‰€æœ‰url
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*" # æ’é™¤ä¸€äº›ä¸å¿…è¦çš„url
        session-stat-enable: true       # å¼€å¯sessionç»Ÿè®¡åŠŸèƒ½
        session-stat-max-count: 1000 # sessionçš„æœ€å¤§ä¸ªæ•°,é»˜è®¤100
      ########## é…ç½®StatViewServletï¼ˆç›‘æ§é¡µé¢ï¼‰ï¼Œç”¨äºå±•ç¤ºDruidçš„ç»Ÿè®¡ä¿¡æ¯ ##########
      stat-view-servlet:
        enabled: true                   # å¯ç”¨StatViewServlet
        url-pattern: /druid/* # è®¿é—®å†…ç½®ç›‘æ§é¡µé¢çš„è·¯å¾„ï¼Œå†…ç½®ç›‘æ§é¡µé¢çš„é¦–é¡µæ˜¯/druid/index.html
        reset-enable: false              # ä¸å…è®¸æ¸…ç©ºç»Ÿè®¡æ•°æ®,é‡æ–°è®¡ç®—
        login-username: root # é…ç½®ç›‘æ§é¡µé¢è®¿é—®å¯†ç 
        login-password: 123
        allow: 127.0.0.1 # å…è®¸è®¿é—®çš„åœ°å€ï¼Œå¦‚æœallowæ²¡æœ‰é…ç½®æˆ–è€…ä¸ºç©ºï¼Œåˆ™å…è®¸æ‰€æœ‰è®¿é—®
        deny: # æ‹’ç»è®¿é—®çš„åœ°å€ï¼Œdenyä¼˜å…ˆäºallowï¼Œå¦‚æœåœ¨denyåˆ—è¡¨ä¸­ï¼Œå°±ç®—åœ¨allowåˆ—è¡¨ä¸­ï¼Œä¹Ÿä¼šè¢«æ‹’ç»
```

tips: é…ç½®äº†æ‹¦æˆªå™¨ï¼Œæ‰€ä»¥è¦æ’é™¤å¯¹druid çš„æ‹¦æˆª.



# å‰ç«¯ç™»å½•æ³¨å†Œ

æŠ€æœ¯é€‰å‹ vue ,React 



## å‰ç«¯é¡¹ç›®åˆå§‹åŒ–

[æ–‡æ¡£æ€»è§ˆ - Ant Design Pro](https://pro.ant.design/zh-CN/docs/overview)

![image-20250310092621034](images/å¼€å‘ç¬”è®°.assets/image-20250310092621034.png)

ä¸‹è½½ä¾èµ– npm install i

å¯åŠ¨æµ‹è¯•: å¯ä»¥ä»¥mock æ–¹å¼å¯åŠ¨ï¼Œä¼šæœ‰ä¸€äº›å‡æ•°æ®

![image-20250310093105046](images/å¼€å‘ç¬”è®°.assets/image-20250310093105046.png)

![image-20250310093255716](images/å¼€å‘ç¬”è®°.assets/image-20250310093255716.png)

åˆ é™¤æ²¡ç”¨çš„å…ƒç´ ï¼Œæ¯”å¦‚è¯´å›½é™…åŒ–ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›ä¸œè¥¿ã€‚

åˆ é™¤å‰ç«¯æµ‹è¯•å’Œmock

![image-20250310093609470](images/å¼€å‘ç¬”è®°.assets/image-20250310093609470.png)

tips: åˆ é™¤ä¸€ä¸‹ï¼Œè®°å½•æµ‹è¯•ä¸€ä¸‹ï¼Œåˆ«å¯åŠ¨ä¸äº†äº†

![image-20250310093923094](images/å¼€å‘ç¬”è®°.assets/image-20250310093923094.png)

![image-20250310093945997](images/å¼€å‘ç¬”è®°.assets/image-20250310093945997.png)

æŠ¥é”™ ![image-20250310094020204](images/å¼€å‘ç¬”è®°.assets/image-20250310094020204.png)

åˆ é™¤å°±è¡Œ ok

æœ€åæ‰‹åŠ¨åˆ é™¤locales æ–‡ä»¶ã€‚

FK: åº”è¯¥æœ€åå†åˆ é™¤MOck å…ƒç´ çš„ã€‚è®°å¾—åœ¨ç§»é™¤å›½é™…åŒ–ä¹‹åä¹Ÿä¼šä¼šæœ‰bugï¼Œæˆ‘è¿™æ¬¡æ²¡æµ‹ï¼Œå¤§æ„äº†ã€‚

è¡¥å……ç§»é™¤çš„éƒ¨åˆ†

æ²¡ç§»é™¤å¹²å‡€å…ƒç´ 

![image-20250310094953204](images/å¼€å‘ç¬”è®°.assets/image-20250310094953204.png)

tips: æ—¶åˆ»æé†’è‡ªå·±åˆ é™¤ä¸œè¥¿åéƒ½åœ¨æµ‹è¯•ä¸€ä¸‹ï¼Œæ˜¯å¦æœ‰é”™è¯¯ã€‚



æ›´æ¢ico,æ›´æ¢titile

æ›¿æ¢logoï¼š [iconfont-é˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“](https://www.iconfont.cn/search/index)




## ç™»å½•é¡µé¢

å…·ä½“é€»è¾‘å°±æ˜¯ç‚¹å‡»ç™»å½•ï¼Œå‘é€axios è¯·æ±‚ï¼Œå¹¶ä¸”æ¥æ”¶åˆ°å“åº”ç»“æœã€‚

ç°åœ¨é¦–å…ˆå°±æ˜¯å†™axiosè¯·æ±‚ã€‚æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†openapi,å°±å¯ä»¥æ ¹æ®æ¥å£æ–‡æ¡£ç”Ÿæˆè¯·æ±‚çš„axios.

é…ç½®openapiï¼ŒæŒ‡å‘æˆ‘ä»¬çš„æ¥å£æ–‡æ¡£jsonæ•°æ®ï¼ˆä¸æ˜¯æ¥å£æ–‡æ¡£åœ°å€ï¼‰

![image-20250310101454712](images/å¼€å‘ç¬”è®°.assets/image-20250310101454712.png)

åœ¨configä¸‹config.tsï¼Œé…ç½®openapiè¯·æ±‚åœ°å€ã€‚

![image-20250310101633971](images/å¼€å‘ç¬”è®°.assets/image-20250310101633971.png)

å¯åŠ¨ opneapi è„šæœ¬

![image-20250310101710879](images/å¼€å‘ç¬”è®°.assets/image-20250310101710879.png)

æˆåŠŸæ˜¾ç¤º

![image-20250310101801150](images/å¼€å‘ç¬”è®°.assets/image-20250310101801150.png)

![image-20250310101812270](images/å¼€å‘ç¬”è®°.assets/image-20250310101812270.png)

ç›´æ¥å–ç™»å½•æµ‹è¯•ï¼Œ

![image-20250310101903568](images/å¼€å‘ç¬”è®°.assets/image-20250310101903568.png)

è¯·æ±‚çš„url,ä¸æ˜¯æˆ‘ä»¬çš„åç«¯åœ°å€ï¼Œé‚£å°±ä¿®æ”¹é€šç”¨è¯·æ±‚ç±»ã€‚

æˆ‘ä»¬è¦ä¿®æ”¹request çš„è¯·æ±‚è·¯å¾„

src ä¸‹ app.tsx



![image-20250310102358735](images/å¼€å‘ç¬”è®°.assets/image-20250310102358735.png)

ä¸ºä»€ä¹ˆè¿˜æ˜¯8000

![image-20250310102839736](images/å¼€å‘ç¬”è®°.assets/image-20250310102839736.png)

æ²¡æ€ä¹ˆå˜åŒ–ï¼Œè‡ªå·±åˆå¥½äº†ï¼Œæˆ‘åªåˆ äº†ä¸€ä¸ªæ— å…³ç´§è¦çš„å…ƒç´ 

![image-20250310103054304](images/å¼€å‘ç¬”è®°.assets/image-20250310103054304.png)

ç°åœ¨æˆ‘é€€å›ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯å“ªä¸ªå…ƒç´ çš„åŸå› ï¼Œå¥½åƒä¸æ˜¯å“ªä¸ªå…ƒç´ çš„åŸå› ï¼Œæœäº†ï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› 

ä¿®æ”¹æˆ‘æ³¨å†Œçš„è¯·æ±‚ï¼Œæ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„ï¼Œæ³¨æ„å‚æ•°ï¼Œè¿”å›å€¼code date,msg.

![image-20250310103647841](images/å¼€å‘ç¬”è®°.assets/image-20250310103647841.png)

![image-20250310103745462](images/å¼€å‘ç¬”è®°.assets/image-20250310103745462.png)

æµ‹è¯•ï¼Œç¡®å®æ˜¯è¯·æ±‚æˆ‘ä»¬çš„åœ°å€äº†ï¼Œä½†æ˜¯åé¢æœ‰ï¼Ÿtoken?xxxxxx

![image-20250310103854383](images/å¼€å‘ç¬”è®°.assets/image-20250310103854383.png)

ç›´æ¥åˆ äº†

![image-20250310104001986](images/å¼€å‘ç¬”è®°.assets/image-20250310104001986.png)

ä¿®æ”¹å![image-20250310104037279](images/å¼€å‘ç¬”è®°.assets/image-20250310104037279.png)

æµ‹è¯•ä¸€ä¸‹

![image-20250310104055246](images/å¼€å‘ç¬”è®°.assets/image-20250310104055246.png)

æ€»ç®—æ­£ç¡®äº†ã€‚ ç°åœ¨è¿˜æ²¡æœ‰å¤„ç†åŒæºé—®é¢˜ã€‚

åç«¯è§£å†³åŒæº

```java

/**
 * å…¨å±€è·¨åŸŸé…ç½®
 * è¯¥ç±»ç”¨äºé…ç½®Spring Bootåº”ç”¨çš„å…¨å±€è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ç­–ç•¥ã€‚
 * é€šè¿‡å®ç°WebMvcConfigureræ¥å£å¹¶é‡å†™addCorsMappingsæ–¹æ³•ï¼Œå¯ä»¥è‡ªå®šä¹‰CORSè§„åˆ™ã€‚
 */
@Configuration // æ ‡è®°è¯¥ç±»ä¸ºé…ç½®ç±»ï¼ŒSpring Bootä¼šè‡ªåŠ¨åŠ è½½å¹¶åº”ç”¨è¯¥é…ç½®
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // é…ç½®CORSè§„åˆ™
        registry.addMapping("/**") // åŒ¹é…æ‰€æœ‰è·¯å¾„ï¼Œå³å¯¹æ‰€æœ‰è¯·æ±‚åº”ç”¨CORSè§„åˆ™
                // å…è®¸è·¨åŸŸè¯·æ±‚æºå¸¦å‡­è¯ä¿¡æ¯ï¼ˆå¦‚Cookiesã€HTTPè®¤è¯ç­‰ï¼‰
                .allowCredentials(true)
                // å…è®¸å“ªäº›åŸŸåè®¿é—®èµ„æºã€‚ä½¿ç”¨allowedOriginPatternsè€Œä¸æ˜¯allowedOriginsï¼Œ
                // å› ä¸ºallowedOrigins("*")ä¸allowCredentials(true)å†²çªã€‚
                // allowedOriginPatternsæ”¯æŒé€šé…ç¬¦ï¼Œä¸”å¯ä»¥ä¸allowCredentials(true)ä¸€èµ·ä½¿ç”¨ã€‚
                .allowedOriginPatterns("*")
                // å…è®¸çš„HTTPæ–¹æ³•ï¼ŒåŒ…æ‹¬GETã€POSTã€PUTã€DELETEå’ŒOPTIONS
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                // å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
                .allowedHeaders("*")
                // æš´éœ²æ‰€æœ‰å“åº”å¤´ï¼Œä½¿å®¢æˆ·ç«¯å¯ä»¥è®¿é—®è¿™äº›å¤´ä¿¡æ¯
                .exposedHeaders("*");
    }
}
```

æµ‹è¯•é€šè¿‡

![image-20250310105125879](images/å¼€å‘ç¬”è®°.assets/image-20250310105125879.png)

æ”¹é€ ![image-20250310105235185](images/å¼€å‘ç¬”è®°.assets/image-20250310105235185.png)

ä¸è¦æ‰‹æœºå·ç™»å½•ï¼Œä¸è¦å¿˜è®°å¯†ç ï¼Œä¸è¦å…¶ä»–æ–¹å¼ç™»å½•ã€‚

åˆ é™¤å°±è¡Œã€‚

å°†å¿˜è®°å¯†ç æ”¹ä¸ºå»æ³¨å†Œã€‚

![image-20250310110943617](images/å¼€å‘ç¬”è®°.assets/image-20250310110943617.png)

æœ‰æ²¡æµ‹è¯•ï¼šFK

å‘æµ‹å‘ç°å‚æ•°é”™è¯¯ï¼ŒåŸå› æ˜¯è¡¨å•å‚æ•°åå’Œåç«¯æ¥å£åç§°ä¸ä¸€è‡´

![image-20250310115000650](images/å¼€å‘ç¬”è®°.assets/image-20250310115000650.png)

ä¿®æ”¹

æµ‹è¯•

![image-20250310115328508](images/å¼€å‘ç¬”è®°.assets/image-20250310115328508.png)

å‘ç°

![image-20250310131623939](images/å¼€å‘ç¬”è®°.assets/image-20250310131623939.png)

é‚£æˆ‘ä»¬ä¸è¯·æ±‚ï¼Œä¸è¡Œï¼Œä¼šæŠ¥é”™

é‚£å°±åç«¯é¦–å…ˆè·å–ç™»å½•çš„æ¥å£

```java
  /**
     * è·å–ç™»å½•ç”¨æˆ·
     * @param request
     * @return
     */
    @GetMapping("/get/login")
    public BaseResponse<LoginUserVo> getLoginUserVo(HttpServletRequest request) {

        LoginUserVo loginUserVo = userService.getLogin(request);
        return ResultUtils.success(loginUserVo);

    }
```

```java
 /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     * @param request
     * @return
     */
    @Override
    public LoginUserVo getLogin(HttpServletRequest request) {
        // è·å–session
        Object user = request.getSession().getAttribute("user");
        if (user == null) {
        throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR, "æœªç™»å½•");
        }
        // æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·
        Long userId = (Long) user;
        User user1 = this.getById(userId);
        // è¿”å›ç»“æœ
        LoginUserVo loginUserVo = new LoginUserVo();
        BeanUtils.copyProperties(user1, loginUserVo);
        return loginUserVo;

    }
```

å‰ç«¯ä½¿ç”¨openapiï¼Œç”Ÿæˆaxiosï¼Œæ›¿æ¢æ‰ä¸Šè¿°çš„è¯·æ±‚ï¼Œæ³¨æ„å“åº”çš„å‚æ•°

![image-20250310133027478](images/å¼€å‘ç¬”è®°.assets/image-20250310133027478.png)



## æ³¨å†Œé¡µé¢

ä»¿ç…§ç™»å½•é¡µé¢å†™

å®šä¹‰è·¯ç”±

![image-20250310111437563](images/å¼€å‘ç¬”è®°.assets/image-20250310111437563.png)



å‘ç°è·³è½¬ä¸äº†ï¼Œå·²è§£å†³ï¼Œå› ä¸ºåç«¯æ²¡æœ‰è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ¥å£ï¼Œä¸è¿‡ä¸ç¬¦åˆé€»è¾‘ï¼Œä¹‹ååœ¨è€ƒè™‘å§

![image-20250310113252394](images/å¼€å‘ç¬”è®°.assets/image-20250310113252394.png)

ä¸ºå•¥ä¼šæœ‰è¿™ä¸ªè¯·æ±‚

![image-20250310113325910](images/å¼€å‘ç¬”è®°.assets/image-20250310113325910.png)

openapi.json,æœ‰ä»€ä¹ˆç”¨ï¼Œæˆ‘ç›´æ¥åˆ äº†

è¿˜æ˜¯é”™ï¼Œåˆ é™¤ç¼“å­˜ï¼Ÿ

![image-20250310114112041](images/å¼€å‘ç¬”è®°.assets/image-20250310114112041.png)

åˆ ä¸æ‰

æˆ‘æœäº†,å…ˆå°±è¿™æ ·å§

å†™é¡µé¢å’Œç»„ä»¶

ä¸Šé¢çš„é—®é¢˜ï¼Œå·²ç»è§£å†³ï¼Œåç«¯å†™è¿‡è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ¥å£ã€‚æ­£å¸¸è·³è½¬å

ä¿®æ”¹æ³¨å†Œé¡µé¢ï¼Œä¸»è¦ä¿®æ”¹å‚æ•°è¡¨å•å‚æ•°åç§°ï¼Œaxiosè¯·æ±‚ï¼Œä»¥åŠè¯·æ±‚å‚æ•°ã€‚

å®ç°æˆåŠŸ



ç™»å½•æœ‰bugï¼Œç™»å½•ååº”è¯¥è·³è½¬åˆ°ä¸»é¡µï¼Œä½†æ˜¯ä¸è·³è½¬ï¼Œé€»è¾‘ä¹Ÿå†™äº†è·³è½¬

![image-20250310135502456](images/å¼€å‘ç¬”è®°.assets/image-20250310135502456.png)

é‚£å°±çœ‹è·¯ç”±ã€‚æ²¡é—®é¢˜

FK,åŸå› æ˜¯å‰ç«¯æ²¡æœ‰æºå¸¦sessionã€‚mad

![image-20250310141941896](images/å¼€å‘ç¬”è®°.assets/image-20250310141941896.png)

å§æ§½ï¼Œæäº†ä¸€ä¸ªå°æ—¶ï¼Œåç«¯debugäº†å¥½å¤šæ¬¡ï¼Œå°±æ˜¯æ­£ç¡®è®¾ç½®äº†session,ä½†æ˜¯æ ¹æ®sessionå³ä½¿è·å¾—ä¸äº†ç”¨æˆ·ï¼Œæƒ³åˆ°äº†å‰ç«¯æ²¡å¸¦session,è¯¥äº†å‰ç«¯ï¼Œæºå¸¦session.è¿˜æ˜¯ä¸è¡Œï¼Œå°±åƒè·¨åŸŸçš„é—®é¢˜ï¼Œä½†æ˜¯è·¨åŸŸä¹Ÿå…è®¸æºå¸¦sessionäº†ã€‚

æœ€åå‘ç°å‰ç«¯è¯¥äº†å¸¦seesion,ç„¶åæ²¡ä¿å­˜ï¼ŒFKã€‹







# fixbug

knife4j æ˜¾ç¤ºä¸æ­£ç¡®ï¼Œæˆ‘çš„æ¥å£æ˜æ˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯æ˜¾ç¤ºçš„åç§°æ˜¯ä¸€æ ·çš„ã€‚

![image-20250310154207320](images/å¼€å‘ç¬”è®°.assets/image-20250310154207320.png)

å¤ç°ï¼š å½“æ—¶åœ¨å†™æ¥å£çš„æ—¶å€™ï¼Œä¸ºäº†æ–¹ä¾¿éƒ½ç›´æ¥å¤åˆ¶ï¼Œç²˜è´´ï¼Œè¯¥æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰è¯¥æ¥å£çš„åç§°ï¼Œå¯¼è‡´å¯åŠ¨æŠ¥é”™ï¼Œç„¶åæ‰ä¿®æ”¹æ¥å£åç§°ï¼Œä½†æ˜¯ä¹‹åå°±å‡ºç°è¿™æ ·äº†ã€‚

ä¸€å¼€å§‹æˆ‘ä¸æ¸…æ¥šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„bug,ç°åœ¨ï¼ˆå¤§æ¦‚è¿‡äº†åŠå¤©ï¼‰ï¼Œçªç„¶æƒ³åˆ°å¯èƒ½æ˜¯ä¸Šè¿°çš„åŸå› ã€‚

è§£å†³ç‰ˆæœ¬ï¼šï¼ˆå°è¯•ä¸€ä¸‹å¯ä¸å¯ä»¥è§£å†³ï¼‰ï¼Œç§»é™¤knife4j ä¾èµ–å’Œé…ç½®,ç„¶åé‡æ–°å¼•å…¥ã€‚å‘ç°ä¸è¡Œã€‚åœ¨å°è¯•åˆ é™¤tagert,é‡æ–°æ‰“åŒ…ï¼Œè¿˜æ˜¯è§£å†³ä¸äº†ï¼Œå–æé—®issueå§





# æ—¥å¿—çš„ä¿®æ”¹ï¼Œè®°å½•è¯·æ±‚çš„ä¸»æœºåç§°ï¼Œmacåœ°å€

è°ƒè¯•çš„æ—¶å€™ï¼Œ

å‡ºç°é”™è¯¯

![image-20250312112755596](images/å¼€å‘ç¬”è®°.assets/image-20250312112755596.png)

çŒœæµ‹æ˜¯æˆ‘ä¸€è‡´æ‰“æ–­ç‚¹ï¼Œæ²¡æœ‰é‡Šæ”¾ï¼Œè¿˜ä¸€ç›´è¯·æ±‚çš„åŸå› 

ä»ä½ æä¾›çš„æ—¥å¿—ä¿¡æ¯æ¥çœ‹ï¼Œä½ çš„åº”ç”¨ç¨‹åºåœ¨å¤„ç†è¯·æ±‚æ—¶æŠ›å‡ºäº†ä¸€ä¸ª `java.lang.StackOverflowError`ã€‚è¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œé€šå¸¸è¡¨ç¤ºç¨‹åºä¸­å­˜åœ¨æ— é™é€’å½’æˆ–è¿‡æ·±çš„åµŒå¥—è°ƒç”¨ï¼Œå¯¼è‡´å †æ ˆæº¢å‡ºã€‚
1. **é—®é¢˜åˆ†æ**

`StackOverflowError` æ˜¯ç”±äºç¨‹åºçš„è°ƒç”¨æ ˆæ·±åº¦è¶…è¿‡äº†JVMçš„é™åˆ¶ï¼ˆé»˜è®¤é€šå¸¸æ˜¯1MBï¼‰ã€‚å¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

+ **æ— é™é€’å½’**ï¼šæŸä¸ªæ–¹æ³•è°ƒç”¨è‡ªèº«ï¼Œä½†æ²¡æœ‰æ­£ç¡®çš„ç»ˆæ­¢æ¡ä»¶ã€‚



é‡å¯è¿˜æ˜¯æŠ¥é”™ï¼Œæƒ³äº†ä¸€ä¸‹åˆšåˆšä¿®æ”¹çš„ä¸œè¥¿ï¼Œåœ¨AOP ä¸­è°ƒç”¨äº†controllerå±‚ã€‚

åŸå› â€**AOP åˆ‡é¢è°ƒç”¨ Controller æ–¹æ³•**ï¼š

+ å¦‚æœåœ¨ AOP åˆ‡é¢ä¸­ç›´æ¥è°ƒç”¨äº† Controller å±‚çš„æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åˆè§¦å‘äº† AOP åˆ‡é¢çš„æ‹¦æˆªï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨ã€‚

æœ¬æ¬¡ä¸»è¦æ˜¯å®ç°ï¼Œä¸»æœºåç§°,ä»¥åŠmacåœ°å€çš„è·å–ã€‚

ä¹‹å‰è®¤ä¸ºåªè¦è®°å½•ipå°±è¡Œäº†ï¼Œä½†æ˜¯åæ¥æƒ³äº†æƒ³ï¼Œç¡®å®å¯èƒ½æœ‰è®°å½•ç”µè„‘åç§°æˆ–åˆ™macåœ°å€çš„éœ€æ±‚ã€‚



åˆ†æä¸€ä¸‹ï¼š

> è®°å½• IP åœ°å€çš„ä½œç”¨å’Œå±€é™æ€§ï¼š 

* **ä½œç”¨**ï¼šIP åœ°å€æ˜¯ç½‘ç»œä¸­è®¾å¤‡çš„é€»è¾‘åœ°å€ï¼Œç”¨äºåœ¨ç½‘ç»œä¸­æ ‡è¯†è®¾å¤‡å¹¶å®ç°æ•°æ®ä¼ è¾“ã€‚è®°å½• IP åœ°å€å¯ä»¥æ–¹ä¾¿ç½‘ç»œç®¡ç†å‘˜è¿›è¡Œç½‘ç»œé…ç½®ã€æ•…éšœæ’æŸ¥ä»¥åŠå¯¹ç½‘ç»œæµé‡è¿›è¡Œç›‘æ§å’Œç®¡ç†ã€‚

+ **å±€é™æ€§**ï¼šIP åœ°å€å¯èƒ½ä¼šåŠ¨æ€åˆ†é…ï¼Œå¯¼è‡´æ¯æ¬¡è®¾å¤‡è¿æ¥ç½‘ç»œæ—¶è·å–çš„ IP åœ°å€å¯èƒ½ä¸åŒã€‚è¿™å°±ä½¿å¾—ä»…ä¾é  IP åœ°å€æ¥é•¿æœŸè·Ÿè¸ªå’Œè¯†åˆ«è®¾å¤‡å­˜åœ¨ä¸€å®šçš„å›°éš¾ã€‚è€Œä¸”åœ¨ä¸€äº›å±€åŸŸç½‘ç¯å¢ƒä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªè®¾å¤‡å…±äº«åŒä¸€ä¸ªå…¬ç½‘ IP åœ°å€çš„æƒ…å†µï¼Œæ­¤æ—¶ä»…è®°å½• IP åœ°å€éš¾ä»¥å‡†ç¡®åŒºåˆ†ä¸åŒçš„è®¾å¤‡ã€‚



>  è®°å½•ç”µè„‘åç§°çš„æ„ä¹‰

+ **æ–¹ä¾¿è¯†åˆ«**ï¼šç”µè„‘åç§°é€šå¸¸æ˜¯ç”¨æˆ·ä¸ºè®¾å¤‡è®¾ç½®çš„ä¸ªæ€§åŒ–æ ‡è¯†ï¼Œå…·æœ‰ä¸€å®šçš„å¯è¯»æ€§å’Œå¯è¯†åˆ«æ€§ã€‚åœ¨ä¼ä¸šæˆ–å®¶åº­ç½‘ç»œä¸­ï¼Œé€šè¿‡è®°å½•ç”µè„‘åç§°å¯ä»¥æ›´ç›´è§‚åœ°çŸ¥é“æ¯å°è®¾å¤‡çš„å½’å±æˆ–ç”¨é€”ã€‚æ¯”å¦‚ï¼Œåœ¨å…¬å¸ç½‘ç»œä¸­ï¼Œâ€œMarketing_Laptop_01â€ è¿™æ ·çš„ç”µè„‘åç§°å¯ä»¥è®©äººå¾ˆå®¹æ˜“çŸ¥é“è¿™æ˜¯å¸‚åœºè¥é”€éƒ¨é—¨çš„æŸå°ç¬”è®°æœ¬ç”µè„‘ï¼Œæ–¹ä¾¿è¿›è¡Œè®¾å¤‡ç®¡ç†å’Œèµ„æºåˆ†é…ã€‚

+ **ä¸ç”¨æˆ·å…³è”**ï¼šç”µè„‘åç§°å¾€å¾€ä¸ä½¿ç”¨è¯¥è®¾å¤‡çš„ç”¨æˆ·ç›¸å…³è”ï¼Œæœ‰åŠ©äºåœ¨ç½‘ç»œç®¡ç†ä¸­è¿½è¸ªç”¨æˆ·çš„æ“ä½œå’Œè¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå½“å‡ºç°ç½‘ç»œå®‰å…¨é—®é¢˜æˆ–å¼‚å¸¸æ“ä½œæ—¶ï¼Œå¯ä»¥æ ¹æ®ç”µè„‘åç§°å¿«é€Ÿå®šä½åˆ°å¯èƒ½æ¶‰åŠçš„ç”¨æˆ·ï¼Œä¾¿äºè¿›è¡Œè°ƒæŸ¥å’Œå¤„ç†ã€‚

> è®°å½• MAC åœ°å€çš„ä»·å€¼

  + **å”¯ä¸€æ ‡è¯†**ï¼šMAC åœ°å€æ˜¯è®¾å¤‡ç½‘ç»œæ¥å£çš„å”¯ä¸€ç‰©ç†æ ‡è¯†ï¼Œå…·æœ‰å…¨çƒå”¯ä¸€æ€§ã€‚æ— è®ºè®¾å¤‡è¿æ¥åˆ°å“ªä¸ªç½‘ç»œï¼Œå…¶ MAC åœ°å€é€šå¸¸æ˜¯ä¸å˜çš„ã€‚è¿™ä½¿å¾— MAC åœ°å€æˆä¸ºåœ¨ç½‘ç»œä¸­å‡†ç¡®è¯†åˆ«å’Œè·Ÿè¸ªè®¾å¤‡çš„é‡è¦ä¾æ®ï¼Œå°¤å…¶åœ¨éœ€è¦é•¿æœŸã€å‡†ç¡®åœ°è®°å½•è®¾å¤‡ä¿¡æ¯çš„åœºæ™¯ä¸­ï¼Œå¦‚ç½‘ç»œå®‰å…¨å®¡è®¡ã€è®¾å¤‡å‡†å…¥æ§åˆ¶ç­‰ï¼Œè®°å½• MAC åœ°å€å¯ä»¥ç¡®ä¿å¯¹è®¾å¤‡çš„è¯†åˆ«ä¸ä¼šå›  IP åœ°å€å˜åŒ–ç­‰å› ç´ è€Œå‡ºç°æ··æ·†ã€‚
  + **ç½‘ç»œç›‘æ§ä¸å®‰å…¨**ï¼šåœ¨ç½‘ç»œç›‘æ§ä¸­ï¼Œè®°å½• MAC åœ°å€å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜å®æ—¶äº†è§£ç½‘ç»œä¸­è¿æ¥çš„è®¾å¤‡æƒ…å†µï¼Œå‘ç°å¼‚å¸¸è®¾å¤‡æˆ–æœªç»æˆæƒçš„æ¥å…¥ã€‚åœ¨æ— çº¿ç½‘ç»œç¯å¢ƒä¸­ï¼Œé€šè¿‡è®°å½• MAC åœ°å€å¯ä»¥è¿›è¡Œ MAC åœ°å€è¿‡æ»¤ï¼Œåªå…è®¸ç‰¹å®š MAC åœ°å€çš„è®¾å¤‡è¿æ¥åˆ°æ— çº¿ç½‘ç»œï¼Œæé«˜ç½‘ç»œçš„å®‰å…¨æ€§ã€‚

æ‰€ä»¥è¯´å¯¹äºå±€åŸŸç½‘é¡¹ç›®æ—¥å¿—çš„è®°å½•ï¼Œå°±æœ‰å¾ˆå¤§çš„å¿…è¦è®°å½•ä¸»æœºåå’Œmacåœ°å€ã€‚



è·å–å®¢æˆ·ç«¯ä¸»æœºåç§°

```java
/**
     * è·å–å®¢æˆ·ç«¯ä¸»æœºå
     * @param clientIp
     * @return
     */
    public static String getClientHostName(String clientIp) {
        try {
            // å¦‚æœæ˜¯IPv6çš„æœ¬åœ°å›ç¯åœ°å€ï¼Œè½¬æ¢ä¸ºIPv4
            if ("0:0:0:0:0:0:0:1".equals(clientIp) || "127.0.0.1".equals(clientIp)) {
                // è·å–æœ¬åœ°ä¸»æœºå è¿™é‡Œä¸è¦é€šè¿‡ip å»è§£æ ä¸»æœºåï¼Œå¯èƒ½ä¼šæœ‰è¯¯ï¼Œå› ä¸ºé€šè¿‡ipè§£æä¸»æœºåç§°ï¼Œæ˜¯æŸ¥dnsç³»ç»Ÿ ip å¯¹åº”çš„ä¸»æœºåï¼Œå¯èƒ½ä¼šæœ‰è¯¯ã€‚
                InetAddress localHost = InetAddress.getLocalHost();
                return localHost.getHostName();
            }

            // ä¸æ˜¯æœ¬åœ°çš„è¯·æ±‚ å°±æ ¹æ®ip è·å¾—IntAddress, ç„¶ååœ¨è·å–ä¸»æœºåç§°
            InetAddress inetAddress = InetAddress.getByName(clientIp);
            return inetAddress.getHostName();
        } catch (UnknownHostException e) {
            return "unknown";
        }
    }
```

è·å–macåœ°å€

```java
   /**
     * è·å–mac åœ°å€
     * @param ipAddress
     * @return
     */
    public static String getMacAddress(String ipAddress) {
        try {
            // å¦‚æœæ˜¯æœ¬åœ°å›ç¯åœ°å€ï¼Œç›´æ¥è¿”å›æœ¬æœºMACåœ°å€
            if ("0:0:0:0:0:0:0:1".equals(ipAddress) || "127.0.0.1".equals(ipAddress)) {
                return getLocalMacAddress();
            }
            Process process = Runtime.getRuntime().exec("arp -a " + ipAddress);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.contains(ipAddress)) {
                    String[] parts = line.split("\\s+");
                    return parts[2]; // MACåœ°å€é€šå¸¸æ˜¯ç¬¬ä¸‰åˆ—ï¼Œ æ‰“æ–­ç‚¹å°±çŸ¥é“
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "æ— æ³•è·å–MACåœ°å€";
    }

    /**
     * è·å–æœ¬æœºçš„mac åœ°å€
     * @return
     */
    public static String getLocalMacAddress() {
        try {
            InetAddress ip = InetAddress.getLocalHost();
            NetworkInterface network = NetworkInterface.getByInetAddress(ip);
            byte[] mac = network.getHardwareAddress();
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i < mac.length; i++) {
                sb.append(String.format("%02X%s", mac[i], (i < mac.length - 1) ? "-" : ""));
            }
            return sb.toString();
        } catch (Exception e) {
            e.printStackTrace();
            return "æ— æ³•è·å–MACåœ°å€";
        }
    }
```

å®Œæ•´çš„åˆ‡é¢è¯·æ±‚

```java
package com.ls.supstar.aop;


import com.ls.supstar.exeception.BusinessException;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;
import org.springframework.util.StopWatch;
import org.springframework.web.context.request.RequestAttributes;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.net.InetAddress;
import java.net.NetworkInterface;
import java.net.UnknownHostException;
import java.util.Random;
import java.util.UUID;
import java.io.BufferedReader;
import java.io.InputStreamReader;


/**
 * æ—¥å¿— AOP
 */
@Component
@Aspect
@Slf4j
public class LogInterceptor {


    @Around("execution(* com.ls.supstar.controller.*.*(..))")
    public Object doInterceptor(ProceedingJoinPoint point) throws Throwable {

        // è®°æ—¶
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        // è·å–è¯·æ±‚çš„è·¯å¾„
        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();

        // ç”Ÿæˆè¯·æ±‚æ—¥å¿—å”¯ä¸€id
        String requestId = UUID.randomUUID().toString();

        // è¯·æ±‚çš„ip
        String requestIp = request.getRemoteAddr();

//        // è¯·æ±‚çš„ä¸»æœºåç§°
        String clientHostName = getClientHostName(requestIp);

        // è¯·æ±‚çš„macåœ°å€
        String macAddress = getMacAddress(requestIp);


        // å‘èµ·è¯·æ±‚çš„ç”¨æˆ·
        Object user = request.getSession().getAttribute("user");

        // è¯·æ±‚url
        String url = request.getRequestURL().toString();



        // todo è¯·æ±‚å‚æ•°, æ³¨æ„éšç§ï¼Œç‰¹åˆ«æ˜¯å¯†ç è¦è¿›è¡ŒåŠ å¯†
//        Object[] args = point.getArgs();
//
//        String reqParam = "[" + StringUtils.join(args, ",") + "]";

        // è¾“å‡ºè¯·æ±‚æ—¥å¿—
//        log.info("request start: requestId:{}, userId:{},requestIp:{},url:{}, reqParam:{}", requestId,user,requestIp, url, reqParam);
        log.info("request start: requestId:{}, userId:{},requestIp:{},clientHostName:{},macAddress:{},url:{}", requestId,user,requestIp,clientHostName,macAddress, url);




        Object result = null;
        try {

            // æ‰§è¡Œç›®æ ‡æ–¹æ³•å¹¶è·å–å“åº”ç»“æœ
            result = point.proceed();

            // å°†å“åº”ç»“æœè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            String respParam = result != null ? result.toString() : "error";

            // è¾“å‡ºå“åº”æ—¥å¿—
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.info("request end: requestId: {}, cost: {}ms, respParam: {}", requestId, totalTimeMillis, respParam);
        } catch (BusinessException e) {
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.error("request end Business exception caught: requestId: {}, cost: {}ms, code: {}, message: {}",
                    requestId, totalTimeMillis, e.getCode(), e.getMessage());
            throw e; // ä¿æŒ BusinessException ç±»å‹ä¸å˜
        } catch (Exception e) {
            stopWatch.stop();
            long totalTimeMillis = stopWatch.getTotalTimeMillis();
            log.error("request end System exception caught: requestId: {}, cost: {}ms, message: {}",
                    requestId, totalTimeMillis, e.getMessage());
            throw e; // ä¿æŒ Exception ç±»å‹ä¸å˜
        }
        return result;

    }


    /**
     * è·å–å®¢æˆ·ç«¯ä¸»æœºå
     * @param clientIp
     * @return
     */
    public static String getClientHostName(String clientIp) {
        try {
            // å¦‚æœæ˜¯IPv6çš„æœ¬åœ°å›ç¯åœ°å€ï¼Œè½¬æ¢ä¸ºIPv4
            if ("0:0:0:0:0:0:0:1".equals(clientIp) || "127.0.0.1".equals(clientIp)) {
                // è·å–æœ¬åœ°ä¸»æœºå è¿™é‡Œä¸è¦é€šè¿‡ip å»è§£æ ä¸»æœºåï¼Œå¯èƒ½ä¼šæœ‰è¯¯ï¼Œå› ä¸ºé€šè¿‡ipè§£æä¸»æœºåç§°ï¼Œæ˜¯æŸ¥dnsç³»ç»Ÿ ip å¯¹åº”çš„ä¸»æœºåï¼Œå¯èƒ½ä¼šæœ‰è¯¯ã€‚
                InetAddress localHost = InetAddress.getLocalHost();
                return localHost.getHostName();
            }

            // ä¸æ˜¯æœ¬åœ°çš„è¯·æ±‚ å°±æ ¹æ®ip è·å¾—IntAddress, ç„¶ååœ¨è·å–ä¸»æœºåç§°
            InetAddress inetAddress = InetAddress.getByName(clientIp);
            return inetAddress.getHostName();
        } catch (UnknownHostException e) {
            return "unknown";
        }
    }

    /**
     * è·å–mac åœ°å€
     * @param ipAddress
     * @return
     */
    public static String getMacAddress(String ipAddress) {
        try {
            // å¦‚æœæ˜¯æœ¬åœ°å›ç¯åœ°å€ï¼Œç›´æ¥è¿”å›æœ¬æœºMACåœ°å€
            if ("0:0:0:0:0:0:0:1".equals(ipAddress) || "127.0.0.1".equals(ipAddress)) {
                return getLocalMacAddress();
            }
            Process process = Runtime.getRuntime().exec("arp -a " + ipAddress);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.contains(ipAddress)) {
                    String[] parts = line.split("\\s+");
                    return parts[2]; // MACåœ°å€é€šå¸¸æ˜¯ç¬¬ä¸‰åˆ—ï¼Œ æ‰“æ–­ç‚¹å°±çŸ¥é“
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "æ— æ³•è·å–MACåœ°å€";
    }

    /**
     * è·å–æœ¬æœºçš„mac åœ°å€
     * @return
     */
    public static String getLocalMacAddress() {
        try {
            InetAddress ip = InetAddress.getLocalHost();
            NetworkInterface network = NetworkInterface.getByInetAddress(ip);
            byte[] mac = network.getHardwareAddress();
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i < mac.length; i++) {
                sb.append(String.format("%02X%s", mac[i], (i < mac.length - 1) ? "-" : ""));
            }
            return sb.toString();
        } catch (Exception e) {
            e.printStackTrace();
            return "æ— æ³•è·å–MACåœ°å€";
        }
    }
}
```



# åˆ†æè€ƒæ ¸æ‰“å¡

## éœ€æ±‚åˆ†æ

ç»Ÿè®¡æ‰“å¡æ—¶é—´åœ¨9ï¼š00 - 18ï¼š15 çš„æ•°æ®ï¼Œè®¡ç®—å‘˜å·¥çš„å·¥æ—¶ã€‚

æ¯ä¸ªå‘˜å·¥ä¸€å¤©å¯èƒ½æœ‰å¤šä¸ªæ‰“å¡è®°å½•ã€‚



åŠŸèƒ½

* æ•°æ®æ¸…æ´— -P0
* æ•°æ®æŸ¥è¯¢-P0

## æµç¨‹åˆ†æ

æ•°æ®æ¸…æ´—ï¼Œæ•°æ®ä¸Šä¼ ï¼Œåç«¯è¯»å–excelï¼Œä¿ç•™æ¯å¤©æœ€æ—©çš„æ•°æ®ï¼Œä»¥åŠæœ€æ™šçš„æ•°æ®ã€‚



1. å¤„ç†åŸå§‹è€ƒå‹¤è®°å½•ï¼ˆæ¥è‡ªExcelï¼‰
2. å­˜å‚¨æ¸…æ´—åçš„è€ƒå‹¤ç»Ÿè®¡æ•°æ®ï¼ˆæ¯æ—¥é¦–æ¬¡å’Œæœ«æ¬¡æ‰“å¡æ—¶é—´ï¼‰
3. æ”¯æŒæŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢ç»Ÿè®¡ç»“æœ



## åº“è¡¨è®¾è®¡

+ **åŸå§‹è€ƒå‹¤è®°å½•**ï¼šåŒ…å«Excelä¸­çš„æ‰€æœ‰å­—æ®µ

| å­—æ®µ                 | ç±»å‹         | è¯´æ˜       | çº¦æŸ               |
| :------------------- | :----------- | :--------- | :----------------- |
| id                   | BIGINT       | ä¸»é”®       | PK, AUTO_INCREMENT |
| employee_id          | VARCHAR(20)  | å‘˜å·¥ç¼–å·   | NOT NULL           |
| name                 | VARCHAR(50)  | å§“å       | NOT NULL           |
| department           | VARCHAR(100) | éƒ¨é—¨       |                    |
| record_date          | DATETIME     | æ‰“å¡æ—¶é—´   | NOT NULL           |
| attendance_status    | VARCHAR(20)  | è€ƒå‹¤çŠ¶æ€   |                    |
| check_point          | VARCHAR(100) | è€ƒå‹¤ç‚¹     |                    |
| custom_name          | VARCHAR(100) | è‡ªå®šä¹‰åç§° |                    |
| data_source          | VARCHAR(50)  | æ•°æ®æ¥æº   |                    |
| process_type         | VARCHAR(50)  | å¤„ç†ç±»å‹   |                    |
| temperature          | VARCHAR(10)  | ä½“æ¸©       |                    |
| temperature_abnormal | VARCHAR(10)  | ä½“æ¸©å¼‚å¸¸   |                    |

**ç´¢å¼•è®¾è®¡**ï¼š

1. ä¸»é”®ç´¢å¼•ï¼š`id`
2. ç»„åˆç´¢å¼•ï¼š`(employee_id, record_date)` - ç”¨äºæŒ‰å‘˜å·¥å’Œæ—¶é—´æŸ¥è¯¢
3. å•åˆ—ç´¢å¼•ï¼š`record_date` - ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢



```sql
-- è€ƒå‹¤è¡¨
-- åŸå§‹è€ƒå‹¤è®°å½•è¡¨ï¼ˆå­˜å‚¨ä»Excelå¯¼å…¥çš„åŸå§‹è€ƒå‹¤æ•°æ®ï¼‰
CREATE TABLE attendance_raw (
                                id                   BIGINT AUTO_INCREMENT COMMENT 'ä¸»é”®ID'
                                    PRIMARY KEY,
                                employee_id          VARCHAR(20)  NOT NULL                COMMENT 'å‘˜å·¥ç¼–å·',
                                employee_name        VARCHAR(50)  NOT NULL                COMMENT 'å‘˜å·¥å§“å',
                                department           VARCHAR(100) NOT NULL                COMMENT 'æ‰€å±éƒ¨é—¨',
                                record_date          DATETIME     NOT NULL                COMMENT 'è€ƒå‹¤è®°å½•æ—¶é—´',
                                attendance_status    VARCHAR(20)                          COMMENT 'è€ƒå‹¤çŠ¶æ€',
                                attendance_point     VARCHAR(100)                         COMMENT 'è€ƒå‹¤ç‚¹',
                                custom_name          VARCHAR(100)                         COMMENT 'è‡ªå®šä¹‰åç§°',
                                data_source          VARCHAR(50)                          COMMENT 'æ•°æ®æ¥æº',
                                process_type         VARCHAR(50)                          COMMENT 'å¤„ç†ç±»å‹',
                                temperature          VARCHAR(10)                          COMMENT 'ä½“æ¸©',
                                temperature_abnormal VARCHAR(10)                          COMMENT 'ä½“æ¸©å¼‚å¸¸',
                                create_time          DATETIME     DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
                                update_time          DATETIME     DEFAULT CURRENT_TIMESTAMP
                                    ON UPDATE CURRENT_TIMESTAMP      COMMENT 'æ›´æ–°æ—¶é—´',

                                CONSTRAINT uk_employee_record
                                    UNIQUE (employee_id, record_date),

                                INDEX idx_date (record_date),
                                INDEX idx_employee_date (employee_id, record_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŸå§‹è€ƒå‹¤è®°å½•è¡¨';
```





* #### è€ƒå‹¤ç»Ÿè®¡è¡¨ `attendance_stat`

| å­—æ®µ           | ç±»å‹         | è¯´æ˜         | çº¦æŸ               |
| :------------- | :----------- | :----------- | :----------------- |
| id             | BIGINT       | ä¸»é”®         | PK, AUTO_INCREMENT |
| employee_id    | VARCHAR(20)  | å‘˜å·¥ç¼–å·     | NOT NULL           |
| name           | VARCHAR(50)  | å§“å         | NOT NULL           |
| department     | VARCHAR(100) | éƒ¨é—¨         |                    |
| work_date      | DATE         | å·¥ä½œæ—¥æœŸ     | NOT NULL           |
| first_check_in | DATETIME     | é¦–æ¬¡æ‰“å¡æ—¶é—´ |                    |
| last_check_out | DATETIME     | æœ«æ¬¡æ‰“å¡æ—¶é—´ |                    |
| check_in_count | INT          | å½“æ—¥æ‰“å¡æ¬¡æ•° | DEFAULT 0          |

1. ä¸»é”®ç´¢å¼•ï¼š`id`
2. å”¯ä¸€ç´¢å¼•ï¼š`(employee_id, work_date)` - ç¡®ä¿æ¯äººæ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
3. å•åˆ—ç´¢å¼•ï¼š`work_date` - ç”¨äºæ—¥æœŸèŒƒå›´æŸ¥è¯¢



```sql
-- è€ƒå‹¤ç»Ÿè®¡è¡¨
-- è€ƒå‹¤ç»Ÿè®¡è¡¨ï¼ˆå­˜å‚¨æŒ‰å‘˜å·¥+æ—¥æœŸèšåˆåçš„è€ƒå‹¤ç»Ÿè®¡æ•°æ®ï¼‰
CREATE TABLE `attendance_summary` (
                                      `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
                                      `employee_id` varchar(20) NOT NULL COMMENT 'å‘˜å·¥ç¼–å·',
                                      `employee_name` varchar(50) NOT NULL COMMENT 'å‘˜å·¥å§“å',
                                      `department` varchar(100) NOT NULL COMMENT 'æ‰€å±éƒ¨é—¨',
                                      `work_date` date NOT NULL COMMENT 'å·¥ä½œæ—¥æœŸ',
                                      `day_of_week` varchar(10) NOT NULL COMMENT 'æ˜ŸæœŸå‡ ',
                                      `first_check_in` time DEFAULT NULL COMMENT 'é¦–æ¬¡æ‰“å¡æ—¶é—´',
                                      `last_check_out` time DEFAULT NULL COMMENT 'æœ€åæ‰“å¡æ—¶é—´',
                                      `work_hours` decimal(5,2) DEFAULT NULL COMMENT 'å·¥ä½œæ—¶é•¿(å°æ—¶)',
                                      `status` varchar(20) DEFAULT 'NORMAL' COMMENT 'è€ƒå‹¤çŠ¶æ€(NORMALæ­£å¸¸, LATEè¿Ÿåˆ°, LEAVE_EARLYæ—©é€€, ABSENTç¼ºå‹¤)',
                                      `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
                                      `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
                                      PRIMARY KEY (`id`),
                                      UNIQUE KEY `uk_employee_date` (`employee_id`, `work_date`),
                                      KEY `idx_date` (`work_date`),
                                      KEY `idx_employee` (`employee_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è€ƒå‹¤ç»Ÿè®¡è¡¨';
```



## åŠŸèƒ½å®ç°

### æ•°æ®æ¸…æ´—åä¿å­˜

æµç¨‹ï¼Œç”¨æˆ·ä¸Šä¼ excelæ–‡ä»¶ï¼Œä½¿ç”¨EazyExcelå®Œæ•´çš„è¯»æ–‡ä»¶ï¼Œç„¶ååšæ•°æ®æ¸…æ´—ï¼Œç„¶åä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå”¯ä¸€é”®çº¦æŸï¼Œ å¯ä»¥ä½¿ç”¨ insert ignore intoï¼‰

1. å¼•å…¥ä¾èµ–

```xml
            <!-- EasyExcel -->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>easyexcel</artifactId>
                <version>4.0.3</version>
            </dependency>
```

2. ç¼–å†™excelå¯¹åº”çš„å®ä½“ç±»çš„æ˜ å°„

```java
@Data
@TableName("attendance_raw")
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AttendanceRaw {
    @TableId(type = IdType.AUTO)
//    @ExcelProperty(value = "ID", converter = CustomLongConverter.class)
    private Long id;

    @TableField("employee_id")
    @ExcelProperty(value = "ç¼–å·")
    private String employeeId;

    @TableField("employee_name")
    @ExcelProperty(value = "å§“å")
    private String employeeName;
    @ExcelProperty(value = "éƒ¨é—¨")
    private String department;

    @TableField("record_date")
    @ExcelProperty(value = "æ—¥æœŸ", converter = CustomDateConverter.class)
    private Date recordDate;

    @TableField("attendance_status")
    @ExcelProperty(value = "è€ƒå‹¤çŠ¶æ€")
    private String attendanceStatus;

    @TableField("attendance_point")
    @ExcelProperty(value = "è€ƒå‹¤ç‚¹")
    private String attendancePoint;

    @TableField("custom_name")
    @ExcelProperty(value = "è‡ªå®šä¹‰åç§°")
    private String customName;

    @TableField("data_source")
    @ExcelProperty(value = "æ•°æ®æ¥æº")
    private String dataSource;

    @TableField("process_type")
    @ExcelProperty(value = "å¤„ç†ç±»å‹")
    private String processType;

    @ExcelProperty(value = "ä½“æ¸©")
    private String temperature;

    @TableField("temperature_abnormal")
    @ExcelProperty(value = "ä½“æ¸©å¼‚å¸¸")
    private String temperatureAbnormal;

    @TableField(value = "create_time", fill = FieldFill.INSERT)
    private Date createTime;

    @TableField(value = "update_time", fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;
}
```

ä¸»è¦çš„æ³¨è§£

* ```shell
   @ExcelProperty(value = "æ—¥æœŸ", converter = CustomDateConverter.class)
  ```

  value =â€xxx" å¯¹åº”excelçš„å¤´éƒ¨åˆ†

  converterï¼Œè‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨

å…·ä½“å®ç°

service æ¥å£

```java
public interface AttendanceRowService {
    /**
     * æ¸…æ´—æ•°æ® å¹¶ä¸”ä¿å­˜åˆ°æ•°æ®åº“
     * @param rawData
     */
    void cleanAndSave(List<AttendanceRaw> rawData);
}

```

service å®ç°

```java
 @Transactional
    public void cleanAndSave(List<AttendanceRaw> rawData) {
        // 1. æ•°æ®æ ¡éªŒ ä¸»è¦æ˜¯ ç”¨æˆ·id ä»¥åŠæ‰“å¡æ—¥å¿—ä¸èƒ½ä¸ºç©º
        List<AttendanceRaw> validData = validateData(rawData);

        // 2. æ•°æ®è½¬æ¢   å»é™¤å¼€å¤´çš„â€˜,â€™
        List<AttendanceRaw> transformedData = transformData(validData);

        // 3. ç­›é€‰æ¯å¤©æœ€æ—©å’Œæœ€æ™šæ‰“å¡è®°å½•
        List<AttendanceRaw> filteredData = filterEarliestAndLatestRecords(transformedData);

        // 4. ä¿å­˜åˆ°æ•°æ®åº“
//        if (!filteredData.isEmpty()) {
////            attendanceRawMapper.insertBatch(filteredData); è‡ªå®šä¹‰sqlç‰ˆæœ¬
//            this.saveBatch(filteredData);
//        }


        // æ‰¹é‡æ’å…¥å¿½ç•¥é‡å¤å€¼
        // 4. æ‰¹é‡æ’å…¥å¿½ç•¥é‡å¤
        if (!filteredData.isEmpty()) {
            try {
                attendanceRawMapper.insertBatchIgnoreDuplicate(filteredData);
            } catch (DuplicateKeyException e) {
                // MySQLæŠ›å‡ºçš„é‡å¤é”®å¼‚å¸¸
                log.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®ï¼Œå·²è‡ªåŠ¨è·³è¿‡");
            } catch (DataIntegrityViolationException e) {
                // å…¶ä»–æ•°æ®åº“å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸
                if (e.getMessage().contains("unique constraint") || e.getMessage().contains("Duplicate entry")) {
                    log.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®ï¼Œå·²è‡ªåŠ¨è·³è¿‡");
                } else {
                    throw e;
                }
            }
        }
    }

    /**
     * ç­›é€‰æ¯å¤©æœ€æ—©å’Œæœ€æ™šæ‰“å¡è®°å½•
     */
    private List<AttendanceRaw> filterEarliestAndLatestRecords(List<AttendanceRaw> data) {
        // æŒ‰å‘˜å·¥IDå’Œæ—¥æœŸåˆ†ç»„
        Map<String, Map<LocalDate, List<AttendanceRaw>>> groupedByEmployeeAndDate = data.stream()
                .collect(Collectors.groupingBy(
                        AttendanceRaw::getEmployeeId,
                        Collectors.groupingBy(record ->
                                record.getRecordDate().toInstant()  // å…ˆè½¬Instant
                                        .atZone(ZoneId.systemDefault()) // è½¬ZonedDateTime
                                        .toLocalDate() // æœ€åå–LocalDate
                        )
                ));

        List<AttendanceRaw> result = new ArrayList<>();

        groupedByEmployeeAndDate.forEach((employeeId, dateMap) -> {
            dateMap.forEach((date, records) -> {
                if (!records.isEmpty()) {
                    // æŒ‰æ‰“å¡æ—¶é—´æ’åº
                    records.sort(Comparator.comparing(AttendanceRaw::getRecordDate));

                    // æ·»åŠ æœ€æ—©è®°å½•
                    result.add(records.get(0));

                    // å¦‚æœæœ‰å¤šæ¡è®°å½•ï¼Œæ·»åŠ æœ€æ™šè®°å½•ï¼ˆæ’é™¤ä¸æœ€æ—©è®°å½•ç›¸åŒçš„æƒ…å†µï¼‰
                    if (records.size() > 1 && !records.get(records.size() - 1).getRecordDate()
                            .equals(records.get(0).getRecordDate())) {
                        result.add(records.get(records.size() - 1));
                    }
                }
            });
        });

        return result;
    }

    // ä¿ç•™åŸæœ‰çš„validateDataå’ŒtransformDataæ–¹æ³•
    private List<AttendanceRaw> validateData(List<AttendanceRaw> rawData) {
        return rawData.stream()
                .filter(record ->
                        StringUtils.isNotBlank(record.getEmployeeId()) &&
                                record.getRecordDate() != null
                )
                .collect(Collectors.toList());
    }

    private List<AttendanceRaw> transformData(List<AttendanceRaw> validData) {
        return validData.stream()
                .peek(record -> {
                    if (record.getEmployeeId().startsWith("'")) {
                        record.setEmployeeId(record.getEmployeeId().substring(1));
                    }

                    if (record.getDepartment() != null) {
                        record.setDepartment(
                                record.getDepartment()
                                        .replace("SUPSTAR/", "")
                                        .trim()
                        );
                    }
                })
                .collect(Collectors.toList());
    }
```



controller ï¼Œä¸»è¦æ˜¯è¯»

```java
@RestController
@RequestMapping("/attendanceRow")
public class AttendanceRowController {

    @Resource
    private AttendanceRowService attendanceRowService;
    // è€ƒå‹¤æ•°æ®æ¸…æ´—


    @PostMapping("/import")
    public BaseResponse<String> importExcel(@RequestParam("file") MultipartFile file) {
        try {
            // 1. ä½¿ç”¨EasyExcelè¯»å–æ•°æ®
            List<AttendanceRaw> rawData = EasyExcel.read(file.getInputStream())
                    .head(AttendanceRaw.class)
                    .sheet("åŸå§‹è€ƒå‹¤è®°å½•æŠ¥è¡¨")
                    .registerConverter(new CustomDateConverter())
                    .doReadSync();

            // 2. æ¸…æ´—å¹¶ä¿å­˜
            attendanceRowService.cleanAndSave(rawData);

            return ResultUtils.success("æ•°æ®å¯¼å…¥æˆåŠŸ");
        } catch (Exception e) {
            throw  new RuntimeException(e);
        }
    }

}
```

å¯¹äºé‡å¤ä¸Šä¼ çš„æ•°æ®ï¼Œä¸åœ¨æ’å…¥ï¼Œæ˜¯æ€ä¹ˆåšçš„ï¼ŒçœŸçš„å¾ˆå·§å¦™ï¼Œè®¾è®¡ä¸€ä¸ªå”¯ä¸€é”®çº¦æŸï¼Œåœ¨æ’å…¥ç›¸åŒé”®çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™æ•°æ®é‡å¤ã€‚Mysqlæä¾›äº†ä¸€ä¸ªsqlè¯­å¥ æ¥å¿½ç•¥è¿™ç§é”™è¯¯ï¼Œè€Œè·³è¿‡æ‰§è¡Œè¿™æ¡è®°å½•

```xml
<mapper namespace="com.ls.supstar.mapper.AttendanceRowMapper">


    <!-- æ‰¹é‡æ’å…¥å¿½ç•¥é‡å¤è®°å½•ï¼ˆMySQLè¯­æ³•ï¼‰ -->
    <insert id="insertBatchIgnoreDuplicate" parameterType="java.util.List">
        INSERT IGNORE INTO attendance_raw
        (employee_id, employee_name, department, record_date, attendance_status,
        attendance_point, custom_name, data_source, process_type, temperature, temperature_abnormal)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.employeeId}, #{item.employeeName}, #{item.department}, #{item.recordDate},
            #{item.attendanceStatus}, #{item.attendancePoint}, #{item.customName}, #{item.dataSource},
            #{item.processType}, #{item.temperature}, #{item.temperatureAbnormal})
        </foreach>
    </insert>
</mapper>
```







